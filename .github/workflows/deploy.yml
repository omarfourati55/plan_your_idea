name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENV_LOCAL: ${{ secrets.ENV_LOCAL }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: ENV_LOCAL
          command_timeout: 10m
          script: |
            export PATH=$PATH:/usr/local/bin:/usr/bin

            cd ${{ secrets.SSH_PATH }}

            # Write .env.local from GitHub Secret
            printf '%s' "$ENV_LOCAL" > .env.local

            # Pull latest code
            git pull origin main

            # Install all dependencies (devDeps needed for build)
            npm ci

            # Build Next.js
            npm run build

            # Start or reload via PM2
            if pm2 describe plan_your_idea > /dev/null 2>&1; then
              pm2 reload ecosystem.config.js --env production
            else
              pm2 start ecosystem.config.js --env production
            fi
            pm2 save

            # Deploy nginx config (idempotent)
            sudo cp nginx.conf /etc/nginx/sites-available/plan_your_idea
            sudo ln -sf /etc/nginx/sites-available/plan_your_idea /etc/nginx/sites-enabled/plan_your_idea
            sudo nginx -t && sudo systemctl reload nginx
